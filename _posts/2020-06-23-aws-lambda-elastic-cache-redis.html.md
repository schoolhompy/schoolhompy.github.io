---
layout: post
title: AWS + LAMBDA + (Elastic cache) REDIS 연동 방법
date: '2020-06-23T08:32:00.001-07:00'
author: schoolhompy
tags:
- redis
- elastic cache
- aws
modified_time: '2020-06-23T08:32:11.372-07:00'
thumbnail: https://1.bp.blogspot.com/-ypwa5WDa_L0/XvIaM8WsGxI/AAAAAAABD34/pepI6xJr5JU70cvZbRhGsFu2TDUIGwe9ACLcBGAsYHQ/s72-c/s1.png
blogger_id: tag:blogger.com,1999:blog-4954243635432022205.post-9214341006134710846
blogger_orig_url: https://yunhos.blogspot.com/2020/06/aws-lambda-elastic-cache-redis.html
---

일단 AWS Elastic cache 는 외부에서 바로 연결이 안된다. 고로, VPC 설정을 해서 , 내부의 AWS Lambda 함수에서 접근이 가능하도록 해야한다.<br />그걸 하기위해서<br />IAM 롤 설정-VPC-SUBNET-LAMBA-API GATEWAY-REDIS-REDIS SUBNET GROUP 설정을 해야한다. 정말 귀찮다.<br /><br />1. IAM 설정<br /><br />Role 에 가서 Lambda 선택(어쭈, 아예 상단에 있네. 많이 쓰란 얘긴가) -&gt; AwsLambdaBasicExecutionRole 선택해서 생성해둔다. 이건 나중에 LAMBDA 기능에서 권한 설정할때 쓴다.<br /><br />2.VPC<br />2-1. VPC 생성<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-ypwa5WDa_L0/XvIaM8WsGxI/AAAAAAABD34/pepI6xJr5JU70cvZbRhGsFu2TDUIGwe9ACLcBGAsYHQ/s1600/s1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="622" data-original-width="1598" height="248" src="https://1.bp.blogspot.com/-ypwa5WDa_L0/XvIaM8WsGxI/AAAAAAABD34/pepI6xJr5JU70cvZbRhGsFu2TDUIGwe9ACLcBGAsYHQ/s640/s1.png" width="640" /></a></div><br />2-2.그밑의 Subnet 도 생성<br />10.0.0.0/28 , 10.0.0.16/28 , 10.0.0.32/28<br />이런식으로 나누어서 생성하면 나중에 zone 별로 지정하기 좋다.<br /><br />2-3.Security Group 도 설정해야 한다. (VPC IP 로 데이터가 나가고 들어오는 보안설정이다)<br /><br />3.Elastic cache Redis<br />3-1 Subnet group 부터 설정한다. 여기서 Zone 별로 Subnet 을 설정하는데, 2-2 에서 여러개 설정해놓았다면 존별로 그것들을 지정하면된다.<br />3-2 Redis 생성 하면 end-point 가 나오는데 그게 내부에서 접속가능한 주소다. 람다에서 접속하자.<br /><br />4.Lambda<br />4-1 새로운 함수를 언어에 맞게 생성한다. 아마존은 크롬을 싫어하니 에디터는 파이어팍스에서 하자. NodeJs 의 경우는 관련패키지가 많이 필요하니 로컬에서 압축파일 만들어서 zip 으로 올리자. [작업-&gt;.zip 업로드]<br />4-2 VPC 지정해야 Lambda 에서 Redis 접속이 가능하다. 설정하자. 보안그룹등도 같이 지정하자.<br />4-3 권한 탭화면에서 IAM 의 권한 지정하자.<br />4-4 이제 외부에서 접속가능하게 API GATEWAY 추가하자<br /><br />5.API GATEWAY<br />5-1 람다화면에서 트리거 추가.<br />5-2 API GATEWAY 설정화면에서 리소스 화면에서 메서드/리소스 다 추가하자<br />5-3 Restful 의 /mymy/sum/1/11 -&gt; /mymy/{whichoper}/{firstvalue}/{lastvalue} 식으로 get/post 하고 싶으면 차례대로 추가하면된다. 단 LAMBDA_PROXY 를 선택해야 된다.<br /><br />6. 외부에서 curl 등으로 접속해보면 된다.<br /><br />const redis&nbsp; &nbsp;= require("ioredis");<br /><br /><br />exports.handler = async (event, context, callback) =&gt; {<br />&nbsp; &nbsp; context.callbackWaitsForEmptyEventLoop = false;&nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; try {<br />&nbsp; &nbsp; &nbsp; &nbsp; //Redis서버접속<br />&nbsp; &nbsp; &nbsp; &nbsp; client = await connectRedis();<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; switch (currentMethos) {<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case "GET":<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; let value = await getValueOfKey(client, keyNameForRedis);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case "POST":<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; await setValueOfKey(client, keyNameForRedis, setVal);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;<br /><br />&nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; //Redis 접속 해제<br />&nbsp; &nbsp; &nbsp; &nbsp; disconnectRedis();<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; return {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; statusCode: 200,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; headers: {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Access-Control-Allow-Headers" : "Content-Type",<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Access-Control-Allow-Origin": "*"<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; body: JSON.stringify(<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; code :&nbsp; resultCode,<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; uuid :&nbsp; in_uuid<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )<br />&nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; } catch (error) {<br />&nbsp; &nbsp; &nbsp; &nbsp; console.error('error:', error);<br />&nbsp; &nbsp; }<br />};<br /><div><div>function connectRedis() {</div><div>&nbsp; &nbsp; return new Promise(function (resolve, reject) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; const client = new redis.Cluster(['//xxxxxxxx.cache.amazonaws.com:6379'],</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slotsRefreshTimeout: 5000</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; );</div><div><br /></div><div><br /></div><div>&nbsp; &nbsp; &nbsp; &nbsp; client.on('connect', () =&gt; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; console.log('Connected');</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resolve(client);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; });</div><div>&nbsp; &nbsp; &nbsp; &nbsp; client.on('error', (error) =&gt; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; console.log(`Connection Error`, error);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reject(error);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; });</div><div>&nbsp; &nbsp; });</div><div>}</div></div><div><div><br /></div><div>function disconnectRedis() {</div><div>&nbsp; &nbsp; if (client) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp;client.disconnect();</div><div>&nbsp; &nbsp; }</div><div>}</div><div><br /></div><div>function getValueOfKey(client, inkey) {</div><div>&nbsp; &nbsp; return new Promise(function (resolve) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; client.get(inkey, (err, reply) =&gt; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(err){</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resolve('error');</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resolve(reply);</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div><br /></div><div>&nbsp; &nbsp; &nbsp; &nbsp; });</div><div>&nbsp; &nbsp; });</div><div>}</div></div><div><div><br /></div><div>function setValueOfKey(client, inkey, invalue) {</div><div>&nbsp; &nbsp;&nbsp;</div><div>&nbsp; &nbsp; return new Promise(function (resolve) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; resolve(client.set(inkey, invalue));</div><div>&nbsp; &nbsp; });</div><div>}</div><div><br /></div><div>function setExpireOfKey(client, inkey, inExpire) {</div><div>&nbsp; &nbsp;&nbsp;</div><div>&nbsp; &nbsp; return new Promise(function (resolve) {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; resolve(client.expire(inkey, inExpire ));</div><div>&nbsp; &nbsp; });</div><div>}</div></div><div><br /></div><div>외부에서 접속하려면 API GATEWAY 항목에서 확인하면된다. 잘된다.</div>