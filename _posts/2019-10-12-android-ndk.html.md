---
layout: post
title: 'Android NDK  작성법 -1 '
date: '2019-10-12T04:50:00.002-07:00'
author: schoolhompy
tags: 
modified_time: '2019-10-12T05:18:11.965-07:00'
thumbnail: https://1.bp.blogspot.com/-ZYImlwVnx3I/XaG-DWhD2XI/AAAAAAABBxA/J9flUuG4b08Tl7zscqlZH_gMlRb0nFF2wCLcBGAsYHQ/s72-c/kim.png
blogger_id: tag:blogger.com,1999:blog-4954243635432022205.post-2998196794962517043
blogger_orig_url: https://yunhos.blogspot.com/2019/10/android-ndk.html
---

C 소스와 연동하기 위해서는 NDK 연동해야 되는데 걍 귀찮네..<br /><div><br /></div><div>일단</div><div>고전적인 방법&nbsp;</div><div><br /></div><div>1. 액티비티 클래스에서 먼저 static 으로 만들고자 하는 ndk 모듈을 로딩한다.</div><div>JniTwo 라는 이름은 C++ 모듈이름으로 Android.mk 에 [ LOCAL_MODULE := jniTwo ] 라고 나중에 똑같이 적으면 된다.<br /><br /></div><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">    <span style="color: #008800; font-weight: bold;">static</span> <span style="color: #333333;">{</span><br />        System<span style="color: #333333;">.</span><span style="color: #0000cc;">loadLibrary</span><span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"jniTwo"</span><span style="color: #333333;">);</span><br />    <span style="color: #333333;">}</span><br /></pre></div><br />2. 모듈을 로드했으면 액티비티 클래스에서 쓸 함수를 이름만 정의한다.<br /><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"> <span style="color: #008800; font-weight: bold;">private</span> <span style="color: #008800; font-weight: bold;">native</span> String <span style="color: #0066bb; font-weight: bold;">getStr</span><span style="color: #333333;">(</span>String str<span style="color: #333333;">);</span><br /></pre></div><br />3. src-&gt;main-&gt;jni 폴더를 만든다.<br />4. 그 안에 cpp 파일을 만든다. * 헤더는 나중에 수동을 만들거다.<br /><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #888888;">//</span><br /><span style="color: #888888;">// Created by kimtaeho on 2019-10-12.</span><br /><span style="color: #888888;">//</span><br /><br /><span style="background-color: #ffaaaa; color: red;">#</span>include <span style="color: #333333;">&lt;</span>string<span style="color: #333333;">.</span><span style="color: #0000cc;">h</span><span style="color: #333333;">&gt;</span><br /><br />JNIEXPORT jstring JNICALL <span style="color: #0066bb; font-weight: bold;">Java_com_example_myapplication_MainActivity_getStr</span><span style="color: #333333;">(</span>JNIEnv <span style="color: #333333;">*</span>env<span style="color: #333333;">,</span> jobject thiz<span style="color: #333333;">,</span> jstring str<span style="color: #333333;">)</span> <span style="color: #333333;">{</span><br />    <span style="color: #333399; font-weight: bold;">char</span> buf<span style="color: #333333;">[</span><span style="color: #0000dd; font-weight: bold;">255</span><span style="color: #333333;">];</span><br />    <span style="color: #333399; font-weight: bold;">char</span> appendMsg<span style="color: #333333;">[]</span> <span style="color: #333333;">=</span> <span style="background-color: #fff0f0;">" JNI Hello"</span><span style="color: #333333;">;</span><br /><br />    <span style="color: #008800; font-weight: bold;">const</span> <span style="color: #333399; font-weight: bold;">char</span> <span style="color: #333333;">*</span>ch1 <span style="color: #333333;">=</span> env<span style="color: #333333;">-&gt;</span>GetStringUTFChars<span style="color: #333333;">(</span>str<span style="color: #333333;">,</span> <span style="color: #0000dd; font-weight: bold;">0</span><span style="color: #333333;">);</span><br />    strcpy<span style="color: #333333;">(</span>buf<span style="color: #333333;">,</span> ch1<span style="color: #333333;">);</span><br />    strcat<span style="color: #333333;">(</span>buf<span style="color: #333333;">,</span> appendMsg<span style="color: #333333;">);</span><br /><br />    <span style="color: #008800; font-weight: bold;">return</span> env<span style="color: #333333;">-&gt;</span>NewStringUTF<span style="color: #333333;">(</span>buf<span style="color: #333333;">);</span><br /><br /> <span style="color: #333333;">}</span><br /></pre></div><br />5. 액티비티 클래스에서 함수를 사용해본다.<br /><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">        TextView ttt <span style="color: #333333;">=</span> <span style="color: #333333;">(</span>TextView<span style="color: #333333;">)</span>findViewById<span style="color: #333333;">(</span>R<span style="color: #333333;">.</span><span style="color: #0000cc;">id</span><span style="color: #333333;">.</span><span style="color: #0000cc;">ttt</span><span style="color: #333333;">);</span><br />        ttt<span style="color: #333333;">.</span><span style="color: #0000cc;">setText</span><span style="color: #333333;">(</span>getStr<span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"Kim"</span><span style="color: #333333;">));</span><br /></pre></div><br />6. Android Studio Setting 에서 Tools-&gt;External Tools 에 새로 생성해서 다음과 같이 적는다.<br /><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">Program <span style="color: #333333;">:</span> <span style="color: #997700; font-weight: bold;">C:</span><span style="background-color: #ffaaaa; color: red;">\</span>Program Files<span style="background-color: #ffaaaa; color: red;">\</span>Java<span style="background-color: #ffaaaa; color: red;">\</span>jdk1<span style="color: #333333;">.</span><span style="color: #6600ee; font-weight: bold;">8.0</span>_191<span style="background-color: #ffaaaa; color: red;">\</span>bin<span style="background-color: #ffaaaa; color: red;">\</span>javah<span style="color: #333333;">.</span><span style="color: #0000cc;">exe</span><br /><br />Arguments <span style="color: #333333;">:</span> <span style="color: #333333;">-</span>classpath <span style="background-color: #fff0f0;">"$Classpath$"</span> <span style="color: #333333;">-</span>v <span style="color: #333333;">-</span>jni $FileClass$<br /><br />Working Directory <span style="color: #333333;">:</span> <span style="color: #997700; font-weight: bold;">C:</span><span style="background-color: #ffaaaa; color: red;">\</span>workspace<span style="background-color: #ffaaaa; color: red;">\</span>MyApplication2<span style="background-color: #ffaaaa; color: red;">\</span>app<span style="background-color: #ffaaaa; color: red;">\</span>src<span style="background-color: #ffaaaa; color: red;">\</span>main<span style="background-color: #ffaaaa; color: red;">\</span>jni<br /></pre></div>7. 이 상태에서 Build-&gt;make Project 를 해본다.<br />8. 모듈을 로드하는 Activity Class 에서 마우스오른쪽 [External Tools] 에서 6에서 생성한 것을 선택하면 복잡한 h 파일이 생성된다. 해당 파일의 맨 밑에 cpp 에서 만든 함수가 정의되어 있는것을 확인하고 파일이름을 적당히 바꾸고 cpp 에서 include 한다.<br />9. jni 폴더에 Android.mk 를 만들어 모듈이름고 소스 파일이름을 지정한다.<br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">LOCAL_PATH <span style="color: #333333;">:=</span> $<span style="color: #333333;">(</span>call my<span style="color: #333333;">-</span>dir<span style="color: #333333;">)</span><br /><br />include $<span style="color: #333333;">(</span>CLEAR_VARS<span style="color: #333333;">)</span><br /><br />LOCAL_MODULE <span style="color: #333333;">:=</span> jniTwo<br />LOCAL_SRC_FILES <span style="color: #333333;">:=</span> Two<span style="color: #333333;">.</span><span style="color: #0000cc;">cpp</span><br />LOCAL_LDLIBS <span style="color: #333333;">:=</span> <span style="color: #333333;">-</span>llog<br /><br />include $<span style="color: #333333;">(</span>BUILD_SHARED_LIBRARY<span style="color: #333333;">)</span><br /></pre></div><br />10. build.gradle(app) 에 다음과 같이 추가.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #008800; font-weight: bold;">import</span> <span style="color: #0e84b5; font-weight: bold;">org.apache.tools.ant.taskdefs.condition.Os</span><br /><br /><br /><br /><span style="color: #888888;">// Project Structure에서 설정한 NDK 경로를 읽어 들여 Return합니다.</span><br />def <span style="color: #0066bb; font-weight: bold;">getNdkBuildPath</span><span style="color: #333333;">()</span> <span style="color: #333333;">{</span><br />    Properties properties <span style="color: #333333;">=</span> <span style="color: #008800; font-weight: bold;">new</span> Properties<span style="color: #333333;">()</span><br />    properties<span style="color: #333333;">.</span><span style="color: #0000cc;">load</span><span style="color: #333333;">(</span>project<span style="color: #333333;">.</span><span style="color: #0000cc;">rootProject</span><span style="color: #333333;">.</span><span style="color: #0000cc;">file</span><span style="color: #333333;">(</span><span style="background-color: #ffaaaa; color: red;">'</span>local<span style="color: #333333;">.</span><span style="color: #0000cc;">properties</span><span style="background-color: #ffaaaa; color: red;">'</span><span style="color: #333333;">).</span><span style="color: #0000cc;">newDataInputStream</span><span style="color: #333333;">())</span><br /><br />    def command <span style="color: #333333;">=</span> properties<span style="color: #333333;">.</span><span style="color: #0000cc;">getProperty</span><span style="color: #333333;">(</span><span style="background-color: #ffaaaa; color: red;">'</span>ndk<span style="color: #333333;">.</span><span style="color: #0000cc;">dir</span><span style="background-color: #ffaaaa; color: red;">'</span><span style="color: #333333;">)</span><br />    <span style="color: #008800; font-weight: bold;">if</span> <span style="color: #333333;">(</span>Os<span style="color: #333333;">.</span><span style="color: #0000cc;">isFamily</span><span style="color: #333333;">(</span>Os<span style="color: #333333;">.</span><span style="color: #0000cc;">FAMILY_WINDOWS</span><span style="color: #333333;">))</span> <span style="color: #333333;">{</span><br />        command <span style="color: #333333;">+=</span> <span style="background-color: #fff0f0;">"\\ndk-build.cmd"</span><br />    <span style="color: #333333;">}</span> <span style="color: #008800; font-weight: bold;">else</span> <span style="color: #333333;">{</span><br />        command <span style="color: #333333;">+=</span> <span style="background-color: #fff0f0;">"/ndk-build"</span><br />    <span style="color: #333333;">}</span><br />    <span style="color: #008800; font-weight: bold;">return</span> command<br /><span style="color: #333333;">}</span><br /><br /><br />Android <span style="color: #333333;">{</span><br /><br /> <span style="color: #333333;">...</span><br /><br /><br /><br />    sourceSets<span style="color: #333333;">.</span><span style="color: #0000cc;">main</span> <span style="color: #333333;">{</span><br />        <span style="color: #888888;">// Compile된 Native Library가 위치하는 경로를 설정합니다.</span><br />        jniLibs<span style="color: #333333;">.</span><span style="color: #0000cc;">srcDir</span> <span style="background-color: #ffaaaa; color: red;">'</span>src<span style="color: #333333;">/</span>main<span style="color: #333333;">/</span>libs<span style="background-color: #ffaaaa; color: red;">'</span><br />        <span style="color: #888888;">// 여기에 JNI Source 경로를 설정하면 Android Studio에서 기본적으로 지원하는 Native</span><br />        <span style="color: #888888;">// Library Build가 이루어집니다. 이 경우에 Android.mk와 Application.mk를</span><br />        <span style="color: #888888;">// 자동으로 생성하기 때문에 편리하지만, 세부 설정이 어렵기 때문에 JNI Source의</span><br />        <span style="color: #888888;">// 경로를 지정하지 않습니다.</span><br />        jni<span style="color: #333333;">.</span><span style="color: #0000cc;">srcDirs</span> <span style="color: #333333;">=</span> <span style="color: #333333;">[]</span><br />    <span style="color: #333333;">}</span><br /><br />    ext <span style="color: #333333;">{</span><br />        <span style="color: #888888;">// 아직은 Task 내에서 Build Type을 구분할 방법이 없기 때문에 이 Property를</span><br />        <span style="color: #888888;">// 이용해 Native Library를 Debugging 가능하도록 Build할 지 결정합니다.</span><br />        nativeDebuggable <span style="color: #333333;">=</span> <span style="color: #008800; font-weight: bold;">true</span><br />    <span style="color: #333333;">}</span><br /><br />    <span style="color: #888888;">// NDK의 ndk-build 명령을 이용하여 Native Library를 Build하기 위한 Task를 정의합니다.</span><br />    <span style="color: #888888;">//noinspection GroovyAssignabilityCheck</span><br />    task <span style="color: #0066bb; font-weight: bold;">buildNative</span><span style="color: #333333;">(</span><span style="color: #997700; font-weight: bold;">type:</span> Exec<span style="color: #333333;">,</span> <span style="color: #997700; font-weight: bold;">description:</span> <span style="background-color: #ffaaaa; color: red;">'</span>Compile JNI source via NDK<span style="background-color: #ffaaaa; color: red;">'</span><span style="color: #333333;">)</span> <span style="color: #333333;">{</span><br />        <span style="color: #008800; font-weight: bold;">if</span> <span style="color: #333333;">(</span>nativeDebuggable<span style="color: #333333;">)</span> <span style="color: #333333;">{</span><br />            commandLine <span style="color: #0066bb; font-weight: bold;">getNdkBuildPath</span><span style="color: #333333;">(),</span> <span style="background-color: #ffaaaa; color: red;">'</span>NDK_DEBUG<span style="color: #333333;">=</span><span style="color: #0000dd; font-weight: bold;">1</span><span style="background-color: #ffaaaa; color: red;">'</span><span style="color: #333333;">,</span> <span style="background-color: #ffaaaa; color: red;">'</span><span style="color: #333333;">-</span>C<span style="background-color: #ffaaaa; color: red;">'</span><span style="color: #333333;">,</span> file<span style="color: #333333;">(</span><span style="background-color: #ffaaaa; color: red;">'</span>src<span style="color: #333333;">/</span>main<span style="background-color: #ffaaaa; color: red;">'</span><span style="color: #333333;">).</span><span style="color: #0000cc;">absolutePath</span><br />        <span style="color: #333333;">}</span> <span style="color: #008800; font-weight: bold;">else</span> <span style="color: #333333;">{</span><br />            commandLine <span style="color: #0066bb; font-weight: bold;">getNdkBuildPath</span><span style="color: #333333;">(),</span> <span style="background-color: #ffaaaa; color: red;">'</span><span style="color: #333333;">-</span>C<span style="background-color: #ffaaaa; color: red;">'</span><span style="color: #333333;">,</span> file<span style="color: #333333;">(</span><span style="background-color: #ffaaaa; color: red;">'</span>src<span style="color: #333333;">/</span>main<span style="background-color: #ffaaaa; color: red;">'</span><span style="color: #333333;">).</span><span style="color: #0000cc;">absolutePath</span><br />        <span style="color: #333333;">}</span><br />    <span style="color: #333333;">}</span><br /><br /><br /><br />    <span style="color: #888888;">// App의 Java Code를 Compile할 때 buildNative Task를 실행하여 Native Library도 같이</span><br />    <span style="color: #888888;">// Build되도록 설정합니다.</span><br />    tasks<span style="color: #333333;">.</span><span style="color: #0000cc;">withType</span><span style="color: #333333;">(</span>JavaCompile<span style="color: #333333;">)</span> <span style="color: #333333;">{</span><br />        compileTask <span style="color: #333333;">-&gt;</span> compileTask<span style="color: #333333;">.</span><span style="color: #0000cc;">dependsOn</span> buildNative<br />    <span style="color: #333333;">}</span><br /><br />    <span style="color: #888888;">// NDK로 생성된 Native Library와 Object를 삭제하기 위한 Task를 정의합니다.</span><br />    <span style="color: #888888;">//noinspection GroovyAssignabilityCheck</span><br />    task <span style="color: #0066bb; font-weight: bold;">cleanNative</span><span style="color: #333333;">(</span><span style="color: #997700; font-weight: bold;">type:</span> Exec<span style="color: #333333;">,</span> <span style="color: #997700; font-weight: bold;">description:</span> <span style="background-color: #ffaaaa; color: red;">'</span>Clean <span style="color: #008800; font-weight: bold;">native</span> objs and lib<span style="background-color: #ffaaaa; color: red;">'</span><span style="color: #333333;">)</span> <span style="color: #333333;">{</span><br />        commandLine <span style="color: #0066bb; font-weight: bold;">getNdkBuildPath</span><span style="color: #333333;">(),</span> <span style="background-color: #ffaaaa; color: red;">'</span><span style="color: #333333;">-</span>C<span style="background-color: #ffaaaa; color: red;">'</span><span style="color: #333333;">,</span> file<span style="color: #333333;">(</span><span style="background-color: #ffaaaa; color: red;">'</span>src<span style="color: #333333;">/</span>main<span style="background-color: #ffaaaa; color: red;">'</span><span style="color: #333333;">).</span><span style="color: #0000cc;">absolutePath</span><span style="color: #333333;">,</span> <span style="background-color: #ffaaaa; color: red;">'</span>clean<span style="background-color: #ffaaaa; color: red;">'</span><br />    <span style="color: #333333;">}</span><br /><br />    <span style="color: #888888;">// Gradle의 clean Task를 실행할 떄, cleanNative Task를 실행하도록 설정합니다.</span><br />    clean<span style="color: #333333;">.</span><span style="color: #0000cc;">dependsOn</span> <span style="background-color: #ffaaaa; color: red;">'</span>cleanNative<span style="background-color: #ffaaaa; color: red;">'</span><br /><br /><br /><br /><span style="color: #333333;">}</span><br /></pre></div><br />11. gradle.properties 에 추가<br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;">android<span style="color: #333333;">.</span><span style="color: #0000cc;">useDeprecatedNdk</span><span style="color: #333333;">=</span><span style="color: #008800; font-weight: bold;">true</span><br /></pre></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-ZYImlwVnx3I/XaG-DWhD2XI/AAAAAAABBxA/J9flUuG4b08Tl7zscqlZH_gMlRb0nFF2wCLcBGAsYHQ/s1600/kim.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="1600" data-original-width="900" height="320" src="https://1.bp.blogspot.com/-ZYImlwVnx3I/XaG-DWhD2XI/AAAAAAABBxA/J9flUuG4b08Tl7zscqlZH_gMlRb0nFF2wCLcBGAsYHQ/s320/kim.png" width="180" /></a></div><br />